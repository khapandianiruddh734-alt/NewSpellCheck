<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniMasterSuite | Debug Fixer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-100 text-slate-800 font-sans min-h-screen p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-indigo-700 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">AI Menu Fixer (Debug Mode)</h1>
                <p class="text-indigo-200 text-sm">Processing items one-by-one for maximum reliability.</p>
            </div>
            <button onclick="location.reload()" class="text-sm bg-indigo-800 hover:bg-indigo-600 px-3 py-1 rounded">Reset</button>
        </div>

        <div class="p-8 space-y-6">
            
            <div>
                <label class="block font-bold text-sm text-slate-600 uppercase mb-2">1. Google API Key</label>
                <input type="password" id="api-key" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Paste your AIza... key here">
            </div>

            <div id="upload-area">
                <label class="block font-bold text-sm text-slate-600 uppercase mb-2">2. Upload Menu File (CSV/Excel)</label>
                <div class="border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 p-10 text-center cursor-pointer hover:bg-indigo-50 transition" onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-cloud-upload-alt text-4xl text-indigo-400 mb-2"></i>
                    <p class="font-medium">Click to Upload</p>
                    <input type="file" id="file-input" class="hidden" accept=".csv, .xlsx, .xls">
                </div>
            </div>

            <div id="process-area" class="hidden">
                <div class="flex justify-between items-end mb-2">
                    <h3 class="font-bold text-lg">Processing...</h3>
                    <span id="progress-text" class="text-sm font-mono text-indigo-600">0/0</span>
                </div>
                
                <div class="w-full bg-slate-200 rounded-full h-4 mb-6 overflow-hidden">
                    <div id="progress-bar" class="bg-indigo-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>

                <div class="bg-slate-900 rounded-lg p-4 h-64 overflow-y-auto font-mono text-xs border border-slate-700 shadow-inner" id="log-window">
                    <div class="text-slate-400">System Ready... Waiting for file.</div>
                </div>
            </div>

            <div id="success-area" class="hidden text-center bg-green-50 p-6 rounded-xl border border-green-200">
                <h2 class="text-2xl font-bold text-green-700 mb-2">Finished!</h2>
                <p id="stats-text" class="text-green-800 mb-4">Process complete.</p>
                <button onclick="downloadFile()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-green-700 transition">
                    <i class="fas fa-download mr-2"></i> Download Fixed Excel
                </button>
            </div>

        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let finalWorkbook = null;
        let logWindow = document.getElementById('log-window');

        // Helper to log messages
        function log(msg, type='info') {
            const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-green-400' : 'text-slate-300');
            const div = document.createElement('div');
            div.className = `${color} mb-1 border-b border-slate-800 pb-1`;
            div.innerHTML = `<span class="opacity-50 mr-2">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            logWindow.appendChild(div);
            logWindow.scrollTop = logWindow.scrollHeight; // Auto scroll
        }

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const apiKey = document.getElementById('api-key').value.trim();

            if (!apiKey) { alert("Please enter API Key!"); return; }
            if (!file) return;

            // UI Switch
            document.getElementById('upload-area').classList.add('hidden');
            document.getElementById('process-area').classList.remove('hidden');
            log(`Reading file: ${file.name}...`);

            try {
                // 1. Read File
                const buffer = await file.arrayBuffer();
                const wb = XLSX.read(buffer, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 }); // Array of Arrays

                log(`File loaded. Found ${rawData.length} rows.`);

                // 2. Setup Output Excel
                const outWb = new ExcelJS.Workbook();
                const outWs = outWb.addWorksheet("Fixed Menu");

                // 3. Initialize AI
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" }); // Use flash for speed

                // 4. Identify Target Column (Look for 'Name', 'Item', or 'Description')
                // If not found, we scan all string columns.
                const header = rawData[0];
                let targetColIndex = -1;
                
                // Simple heuristic to find the food column
                if (header) {
                    const headerLower = header.map(h => String(h).toLowerCase());
                    targetColIndex = headerLower.findIndex(h => h.includes('name') || h.includes('item') || h.includes('dish'));
                }

                // Add header to output
                outWs.addRow(header);

                // 5. Process Rows
                let totalFixed = 0;
                let itemsToProcess = [];

                // Prepare list of items
                for (let i = 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    // Add to output immediately (we'll update cell later)
                    const newRow = outWs.addRow(row);
                    
                    // Determine which cell to check
                    let cellVal = targetColIndex > -1 ? row[targetColIndex] : row[0]; // Default to col 0 if no header match
                    let colIdx = targetColIndex > -1 ? targetColIndex + 1 : 1; // 1-based index for ExcelJS

                    if (typeof cellVal === 'string' && cellVal.length > 3) {
                        itemsToProcess.push({ 
                            rowIndex: i + 1, // ExcelJS row index (1 header + i rows)
                            colIndex: colIdx,
                            text: cellVal 
                        });
                    }
                }

                log(`Identified ${itemsToProcess.length} text items to check.`);

                // 6. Execution Loop (One by One)
                for (let i = 0; i < itemsToProcess.length; i++) {
                    const item = itemsToProcess[i];
                    
                    // Update Progress UI
                    document.getElementById('progress-text').innerText = `${i+1}/${itemsToProcess.length}`;
                    document.getElementById('progress-bar').style.width = `${((i+1)/itemsToProcess.length)*100}%`;

                    try {
                        const prompt = `
                            Fix spelling for this menu item: "${item.text}"
                            Context: Indian/Chinese Restaurant.
                            Examples: "Buter Noon" -> "Butter Naan", "Fires" -> "Fries".
                            Return ONLY the corrected text. If correct, return original.
                        `;

                        const result = await model.generateContent(prompt);
                        const fixed = result.response.text().trim();

                        if (fixed && fixed !== item.text) {
                            // Update Excel Cell
                            const cell = outWs.getCell(item.rowIndex, item.colIndex);
                            cell.value = fixed;
                            cell.font = { color: { argb: 'FFFF0000' }, bold: true }; // Red color
                            
                            totalFixed++;
                            log(`FIXED: "${item.text}" -> "${fixed}"`, 'success');
                        } else {
                            // log(`Checked: "${item.text}" (No change)`);
                        }

                    } catch (err) {
                        log(`API Error on row ${item.rowIndex}: ${err.message}`, 'error');
                        // Wait 2 seconds if error (rate limit)
                        await new Promise(r => setTimeout(r, 2000));
                    }
                    
                    // Small delay to be polite to API
                    await new Promise(r => setTimeout(r, 200)); 
                }

                // Finish
                finalWorkbook = outWb;
                document.getElementById('process-area').classList.add('hidden');
                document.getElementById('success-area').classList.remove('hidden');
                document.getElementById('stats-text').innerText = `Scanned ${itemsToProcess.length} items. Fixed ${totalFixed} errors.`;

            } catch (err) {
                console.error(err);
                log(`CRITICAL ERROR: ${err.message}`, 'error');
                alert("Stopped due to error. Check logs.");
            }
        });

        window.downloadResult = async function() {
            if(!finalWorkbook) return;
            const buffer = await finalWorkbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            saveAs(blob, "Fixed_Menu_Result.xlsx");
        }
    </script>
</body>
</html>
