<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Achievers | Multi-Page Pro Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #1a1a1b; font-family: 'Inter', sans-serif; }
        #editor-viewport { height: calc(100vh - 64px); overflow-y: auto; scroll-behavior: smooth; }
        .page-wrapper { 
            position: relative; 
            margin: 20px auto; 
            background: white; 
            box-shadow: 0 0 20px rgba(0,0,0,0.4); 
            border-radius: 4px;
        }
        .canvas-container { position: absolute !important; top: 0; left: 0; }
        .active-page-border { outline: 4px solid #4f46e5; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-gray-100">

    <nav class="h-16 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-6 z-50">
        <div class="flex items-center gap-4">
            <span class="text-xl font-bold text-indigo-500">The <span class="text-white">Achievers</span></span>
            <span id="page-indicator" class="bg-gray-800 px-3 py-1 rounded text-xs text-gray-400">Page: 0/0</span>
        </div>
        <div class="flex gap-3">
            <button onclick="document.getElementById('upload-pdf').click()" class="text-sm font-semibold hover:text-indigo-400 transition">
                <i class="fas fa-folder-open mr-2"></i> Load PDF
            </button>
            <button onclick="exportFinalPDF()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded-lg text-sm font-bold transition shadow-lg">
                <i class="fas fa-save mr-2"></i> Download Final PDF
            </button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-80 bg-gray-900 border-r border-gray-800 p-6 flex flex-col gap-8">
            <section>
                <h3 class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] mb-4">Text Styling</h3>
                <input type="text" id="text-val" placeholder="Enter text..." class="w-full bg-gray-800 border border-gray-700 p-3 rounded-lg text-sm mb-3 focus:border-indigo-500 outline-none">
                <button onclick="addText()" class="w-full bg-white text-black py-3 rounded-lg text-sm font-bold hover:bg-gray-200 transition">
                    <i class="fas fa-plus-circle mr-2"></i> Add to Active Page
                </button>
            </section>

            <section>
                <h3 class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] mb-4">Media Tool</h3>
                <input type="file" id="img-upload" accept="image/*" class="hidden" onchange="addImageToCanvas(this)">
                <button onclick="document.getElementById('img-upload').click()" class="w-full bg-gray-800 border border-gray-700 py-4 rounded-xl font-bold text-sm hover:border-indigo-500 transition">
                    <i class="fas fa-image mb-2 block text-xl text-indigo-400"></i>
                    Upload & Resize Image
                </button>
            </section>

            <div class="mt-auto p-4 bg-indigo-900/20 border border-indigo-500/30 rounded-lg">
                <p class="text-[11px] text-indigo-300 leading-relaxed">
                    <i class="fas fa-info-circle mr-1"></i> 
                    <b>How to edit:</b> Scroll to the page you want to change. The editor will automatically target the page currently in view.
                </p>
            </div>
        </aside>

        <main id="editor-viewport" class="flex-1 p-8">
            <div id="pages-container" class="flex flex-col items-center">
                <div id="welcome" class="mt-32 text-center text-gray-500">
                    <i class="fas fa-file-signature text-6xl mb-4 opacity-20"></i>
                    <p>Upload a PDF to start multi-page editing</p>
                </div>
            </div>
        </main>
    </div>

    <input type="file" id="upload-pdf" accept="application/pdf" class="hidden">

    <script>
        const { PDFDocument } = PDFLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let originalPdfBytes;
        let fabricCanvases = []; 
        let activePageIndex = 0;

        // --- 1. LOAD & RENDER ALL PAGES ---
        document.getElementById('upload-pdf').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            originalPdfBytes = await file.arrayBuffer();
            const pdfData = new Uint8Array(originalPdfBytes);
            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
            
            const container = document.getElementById('pages-container');
            container.innerHTML = '';
            fabricCanvases = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });

                const wrapper = document.createElement('div');
                wrapper.className = 'page-wrapper';
                wrapper.style.width = `${viewport.width}px`;
                wrapper.style.height = `${viewport.height}px`;
                wrapper.dataset.index = i - 1;

                const bgCanvas = document.createElement('canvas');
                bgCanvas.width = viewport.width;
                bgCanvas.height = viewport.height;
                
                const fgCanvas = document.createElement('canvas');
                fgCanvas.id = `page-${i}`;

                wrapper.appendChild(bgCanvas);
                wrapper.appendChild(fgCanvas);
                container.appendChild(wrapper);

                await page.render({ canvasContext: bgCanvas.getContext('2d'), viewport }).promise;

                const fCanvas = new fabric.Canvas(`page-${i}`, {
                    width: viewport.width,
                    height: viewport.height,
                });
                fabricCanvases.push(fCanvas);
            }
            updatePageIndicator();
        });

        // --- 2. DETECT ACTIVE PAGE ON SCROLL ---
        document.getElementById('editor-viewport').addEventListener('scroll', () => {
            const wrappers = document.querySelectorAll('.page-wrapper');
            let currentIdx = 0;
            wrappers.forEach((w, idx) => {
                const rect = w.getBoundingClientRect();
                if (rect.top < window.innerHeight / 2 && rect.bottom > window.innerHeight / 2) {
                    currentIdx = idx;
                    w.classList.add('active-page-border');
                } else {
                    w.classList.remove('active-page-border');
                }
            });
            activePageIndex = currentIdx;
            updatePageIndicator();
        });

        function updatePageIndicator() {
            const el = document.getElementById('page-indicator');
            if(fabricCanvases.length > 0) {
                el.innerText = `Page: ${activePageIndex + 1} / ${fabricCanvases.length}`;
            }
        }

        // --- 3. EDITING TOOLS ---
        function addText() {
            const val = document.getElementById('text-val').value || "New Text";
            const canvas = fabricCanvases[activePageIndex];
            if(!canvas) return;

            const text = new fabric.IText(val, {
                left: 50,
                top: 50,
                fontFamily: 'Helvetica',
                fontSize: 30,
                fill: '#6366f1',
                fontWeight: 'bold'
            });
            canvas.add(text).setActiveObject(text);
        }

        function addImageToCanvas(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fabric.Image.fromURL(e.target.result, function(img) {
                        img.scaleToWidth(200);
                        const canvas = fabricCanvases[activePageIndex];
                        canvas.add(img).setActiveObject(img);
                    });
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 4. EXPORT FINAL MERGED PDF ---
        async function exportFinalPDF() {
            const pdfDoc = await PDFDocument.load(originalPdfBytes);
            const pages = pdfDoc.getPages();

            for (let i = 0; i < fabricCanvases.length; i++) {
                const canvas = fabricCanvases[i];
                // Only process if the user actually added something to this page
                if (canvas.getObjects().length === 0) continue;

                const pdfPage = pages[i];
                const { width, height } = pdfPage.getSize();
                
                const dataURL = canvas.toDataURL({ format: 'png', multiplier: 2 });
                const imageBytes = await fetch(dataURL).then(res => res.arrayBuffer());
                const pngImage = await pdfDoc.embedPng(imageBytes);

                pdfPage.drawImage(pngImage, {
                    x: 0,
                    y: 0,
                    width: width,
                    height: height,
                });
            }

            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: "application/pdf" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "Edited_Document.pdf";
            link.click();
        }
    </script>
</body>
</html>
