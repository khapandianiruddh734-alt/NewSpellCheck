<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Achievers | Edit PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f3f4f6; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        #main-content { flex: 1; display: flex; overflow: hidden; }
        
        /* Thumbnails Sidebar */
        #thumbnail-sidebar { width: 120px; background: #ffffff; border-right: 1px solid #e5e7eb; overflow-y: auto; padding: 10px; }
        .thumb-page { border: 2px solid #e5e7eb; margin-bottom: 10px; cursor: pointer; border-radius: 4px; overflow: hidden; }
        .thumb-page.active { border-color: #4f46e5; box-shadow: 0 0 5px rgba(79, 70, 229, 0.5); }
        .thumb-label { font-size: 10px; text-align: center; color: #6b7280; padding: 2px; }

        /* Workspace */
        #editor-viewport { flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; padding: 40px 0; background: #e5e7eb; scroll-behavior: smooth; }
        .page-wrapper { position: relative; margin-bottom: 40px; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .canvas-container { position: absolute !important; top: 0; left: 0; }

        /* Right Sidebar Info */
        #right-sidebar { width: 250px; background: #ffffff; border-left: 1px solid #e5e7eb; padding: 20px; }

        /* Floating Bottom Bar */
        #bottom-toolbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #374151; color: white; padding: 8px 16px; border-radius: 8px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 100; }
        
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #4f46e5; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav class="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 z-50">
        <div class="flex items-center gap-6">
            <button onclick="document.getElementById('upload-pdf').click()" class="text-sm font-medium px-3 py-1.5 border rounded hover:bg-gray-50 flex items-center gap-2">
                <i class="fas fa-file-pdf text-red-500"></i> Open File
            </button>
            <div class="h-6 w-px bg-gray-300"></div>
            <div class="flex items-center gap-4 text-gray-600">
                <button onclick="addText()" class="hover:text-indigo-600 flex flex-col items-center"><i class="fas fa-font"></i><span class="text-[10px]">Text</span></button>
                <button onclick="document.getElementById('img-upload').click()" class="hover:text-indigo-600 flex flex-col items-center"><i class="fas fa-image"></i><span class="text-[10px]">Image</span></button>
                <button onclick="deleteSelected()" class="hover:text-red-600 flex flex-col items-center"><i class="fas fa-trash"></i><span class="text-[10px]">Delete</span></button>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <h1 class="text-lg font-bold text-gray-800">Edit PDF</h1>
            <button onclick="exportFinalPDF()" id="save-btn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                Export PDF <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </nav>

    <div id="main-content">
        <aside id="thumbnail-sidebar">
            <div id="thumbs-list"></div>
        </aside>

        <main id="editor-viewport">
            <div id="pages-container" class="flex flex-col items-center">
                <div class="text-gray-400 mt-20 text-center">
                    <i class="fas fa-cloud-upload-alt text-5xl mb-4"></i>
                    <p>Load a PDF to see all pages</p>
                </div>
            </div>
        </main>

        <aside id="right-sidebar">
            <div class="bg-blue-50 border border-blue-100 p-4 rounded-lg">
                <h4 class="text-xs font-bold text-blue-800 uppercase mb-2">Instructions</h4>
                <p class="text-xs text-blue-600 leading-relaxed">
                    Use the toolbar to modify or add text, upload images, and annotate with ease. Click any element to resize or delete.
                </p>
            </div>
            <div class="mt-8">
                <label class="text-[10px] font-bold text-gray-400 uppercase">Text Value</label>
                <input type="text" id="text-input" placeholder="Enter text..." class="w-full mt-1 p-2 text-sm border rounded focus:ring-1 ring-red-400 outline-none">
                <p class="text-[10px] text-gray-400 mt-1 italic">Text will be added in <span class="text-red-500">Red</span> by default.</p>
            </div>
        </aside>
    </div>

    <div id="bottom-toolbar">
        <button onclick="changePage(-1)"><i class="fas fa-chevron-up"></i></button>
        <span id="page-num-indicator" class="bg-gray-600 px-3 py-0.5 rounded text-sm">1 / 1</span>
        <button onclick="changePage(1)"><i class="fas fa-chevron-down"></i></button>
        <div class="w-px h-4 bg-gray-500"></div>
        <button><i class="fas fa-minus"></i></button>
        <span class="text-sm">100%</span>
        <button><i class="fas fa-plus"></i></button>
    </div>

    <input type="file" id="upload-pdf" accept="application/pdf" class="hidden">
    <input type="file" id="img-upload" accept="image/*" class="hidden" onchange="addImageToCanvas(this)">

    <script>
        const { PDFDocument } = PDFLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let originalPdfBytes;
        let fabricCanvases = []; 
        let activePageIndex = 0;

        // 1. Loading and Rendering
        document.getElementById('upload-pdf').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            originalPdfBytes = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(originalPdfBytes) }).promise;
            
            const container = document.getElementById('pages-container');
            const thumbList = document.getElementById('thumbs-list');
            container.innerHTML = '';
            thumbList.innerHTML = '';
            fabricCanvases = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });

                // Create Page Wrapper
                const wrapper = document.createElement('div');
                wrapper.className = 'page-wrapper';
                wrapper.id = `wrapper-${i-1}`;
                wrapper.style.width = `${viewport.width}px`;
                wrapper.style.height = `${viewport.height}px`;

                const bgCanvas = document.createElement('canvas');
                bgCanvas.width = viewport.width;
                bgCanvas.height = viewport.height;
                
                const fgCanvas = document.createElement('canvas');
                fgCanvas.id = `fabric-${i}`;

                wrapper.appendChild(bgCanvas);
                wrapper.appendChild(fgCanvas);
                container.appendChild(wrapper);

                // Render Background PDF
                await page.render({ canvasContext: bgCanvas.getContext('2d'), viewport }).promise;

                // Init Fabric Overlay
                const fCanvas = new fabric.Canvas(`fabric-${i}`, {
                    width: viewport.width,
                    height: viewport.height,
                });
                fabricCanvases.push(fCanvas);

                // Create Thumbnail
                const thumb = document.createElement('div');
                thumb.className = `thumb-page ${i===1?'active':''}`;
                thumb.onclick = () => scrollToPage(i-1);
                
                const thumbCanvas = document.createElement('canvas');
                const tCtx = thumbCanvas.getContext('2d');
                const tViewport = page.getViewport({ scale: 0.15 });
                thumbCanvas.width = tViewport.width;
                thumbCanvas.height = tViewport.height;
                await page.render({ canvasContext: tCtx, viewport: tViewport }).promise;
                
                thumb.appendChild(thumbCanvas);
                const label = document.createElement('div');
                label.className = 'thumb-label';
                label.innerText = i;
                thumb.appendChild(label);
                thumbList.appendChild(thumb);
            }
            updateIndicators();
        });

        // 2. Navigation
        function scrollToPage(idx) {
            const target = document.getElementById(`wrapper-${idx}`);
            target.scrollIntoView({ behavior: 'smooth' });
            activePageIndex = idx;
            updateIndicators();
        }

        document.getElementById('editor-viewport').addEventListener('scroll', () => {
            const wrappers = document.querySelectorAll('.page-wrapper');
            wrappers.forEach((w, idx) => {
                const rect = w.getBoundingClientRect();
                if (rect.top < window.innerHeight / 2 && rect.bottom > window.innerHeight / 2) {
                    activePageIndex = idx;
                    document.querySelectorAll('.thumb-page').forEach(t => t.classList.remove('active'));
                    document.getElementById('thumbs-list').children[idx].classList.add('active');
                }
            });
            updateIndicators();
        });

        function updateIndicators() {
            document.getElementById('page-num-indicator').innerText = `${activePageIndex + 1} / ${fabricCanvases.length || 1}`;
        }

        // 3. Tools (Always use Red Text)
        function addText() {
            const val = document.getElementById('text-input').value || "Edit Text";
            const canvas = fabricCanvases[activePageIndex];
            if(!canvas) return;

            const text = new fabric.IText(val, {
                left: 100,
                top: 100,
                fontFamily: 'Arial',
                fontSize: 24,
                fill: '#ef4444', // Red text as requested
                fontWeight: 'bold'
            });
            canvas.add(text).setActiveObject(text);
        }

        function addImageToCanvas(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fabric.Image.fromURL(e.target.result, function(img) {
                        img.scaleToWidth(200);
                        fabricCanvases[activePageIndex].add(img).setActiveObject(img);
                    });
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function deleteSelected() {
            const canvas = fabricCanvases[activePageIndex];
            if(canvas && canvas.getActiveObject()) {
                canvas.remove(canvas.getActiveObject());
            }
        }

        // 4. Working Export Logic
        async function exportFinalPDF() {
            const btn = document.getElementById('save-btn');
            btn.innerHTML = `<span class="loader"></span> Saving...`;
            btn.disabled = true;

            try {
                const pdfDoc = await PDFDocument.load(originalPdfBytes);
                const pages = pdfDoc.getPages();

                for (let i = 0; i < fabricCanvases.length; i++) {
                    const canvas = fabricCanvases[i];
                    if (canvas.getObjects().length === 0) continue;

                    const pdfPage = pages[i];
                    const { width, height } = pdfPage.getSize();
                    
                    // High quality merge (multiplier 2)
                    const dataURL = canvas.toDataURL({ format: 'png', multiplier: 2 });
                    const imageBytes = await fetch(dataURL).then(res => res.arrayBuffer());
                    const pngImage = await pdfDoc.embedPng(imageBytes);

                    pdfPage.drawImage(pngImage, {
                        x: 0,
                        y: 0,
                        width: width,
                        height: height,
                    });
                }

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "Edited_Menu.pdf";
                link.click();
            } catch (err) {
                console.error(err);
                alert("Error saving PDF. Check console.");
            } finally {
                btn.innerHTML = `Export PDF <i class="fas fa-arrow-right"></i>`;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
