<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniMasterSuite | Final Fixer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .tool-btn { transition: all 0.2s; }
        .tool-btn:hover { transform: translateY(-2px); }
        .loader { border: 3px solid #e2e8f0; border-top: 3px solid #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <nav class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-6 h-16 flex items-center justify-between">
            <span class="text-xl font-bold text-indigo-600 tracking-tight">AniMaster<span class="text-slate-800">Suite</span></span>
            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">V3.0 STABLE</span>
        </div>
    </nav>

    <div class="flex-grow max-w-3xl mx-auto px-4 py-10 w-full">
        
        <div class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
            
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-white text-center">
                <h1 class="text-3xl font-bold mb-2">AI Menu Spelling Fixer</h1>
                <p class="opacity-90">Upload your CSV/Excel. We fix "Buter Noon" â†’ "Butter Naan".</p>
            </div>

            <div class="p-8">
                
                <div class="mb-8">
                    <label class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">1. Enter Google API Key</label>
                    <div class="relative">
                        <input type="password" id="api-key" class="w-full p-4 pl-12 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="Paste AIza... key here">
                        <i class="fas fa-key absolute left-4 top-5 text-slate-400"></i>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">
                        Get a free key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-600 font-bold underline">Google AI Studio</a>.
                    </p>
                </div>

                <div id="upload-section" class="mb-8">
                    <label class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">2. Upload Menu File</label>
                    <div class="border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 p-10 text-center cursor-pointer hover:bg-indigo-50 hover:border-indigo-400 transition group" onclick="document.getElementById('file-input').click()">
                        <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm group-hover:scale-110 transition text-indigo-600 text-2xl">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <span class="text-lg font-semibold text-slate-700">Click to Upload CSV / Excel</span>
                        <input type="file" id="file-input" class="hidden" accept=".csv, .xlsx, .xls">
                    </div>
                </div>

                <div id="processing-view" class="hidden text-center py-8">
                    <div class="loader mx-auto mb-4 h-12 w-12 border-4"></div>
                    <h3 class="text-xl font-bold text-indigo-600" id="status-title">Starting AI...</h3>
                    <p class="text-slate-500 mt-2 mb-6" id="status-desc">Initializing connection...</p>
                    
                    <div class="w-full bg-slate-200 rounded-full h-4 mb-4 overflow-hidden">
                        <div id="progress-bar" class="bg-indigo-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    
                    <div id="logs-area" class="h-32 overflow-y-auto bg-slate-900 text-green-400 text-xs text-left p-4 rounded-lg font-mono">
                        <p>> System Ready...</p>
                    </div>
                </div>

                <div id="success-view" class="hidden text-center bg-green-50 p-8 rounded-xl border border-green-200">
                    <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                        <i class="fas fa-check"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-green-800 mb-2">Fixing Complete!</h2>
                    <p id="result-stats" class="text-green-700 mb-6">Fixed 0 spelling errors.</p>
                    <button onclick="downloadResult()" class="bg-green-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition w-full sm:w-auto">
                        <i class="fas fa-download mr-2"></i> Download Fixed File
                    </button>
                    <button onclick="location.reload()" class="block mt-4 text-sm text-slate-500 hover:text-slate-700 underline mx-auto">Start Over</button>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Global Variables
        let processedWorkbook = null; 
        
        // Expose function for the file input
        document.getElementById('file-input').addEventListener('change', handleFileSelect);

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) {
                alert("Please paste your Google API Key first!");
                return;
            }

            // Switch UI
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('processing-view').classList.remove('hidden');
            const logBox = document.getElementById('logs-area');
            const log = (msg) => { 
                logBox.innerHTML += `<p>> ${msg}</p>`; 
                logBox.scrollTop = logBox.scrollHeight; 
            };

            log(`Reading file: ${file.name}...`);

            try {
                // 1. Read File
                const buffer = await file.arrayBuffer();
                const workbook = XLSX.read(buffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // Convert to JSON array (header:1 gives array of arrays)
                const rawData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                log(`Loaded ${rawData.length} rows.`);

                // 2. Prepare Output
                const outWb = new ExcelJS.Workbook();
                const outWs = outWb.addWorksheet("Fixed Menu");

                // 3. Initialize AI
                // Use 'gemini-1.5-flash' for speed. If 404, fallback to 'gemini-pro'.
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" }); 

                // 4. Identify Text Columns (Skip headers - Row 0)
                let tasks = [];
                
                // We loop starting from Row 1 (assuming Row 0 is header)
                for (let r = 1; r < rawData.length; r++) {
                    const row = rawData[r];
                    // Add row to output sheet immediately (we will modify cells later)
                    // Note: We add ALL rows first, then update them.
                }

                // Actually, let's process batch by batch
                // Collect ALL text cells that look like food items
                let cellsToFix = [];
                
                rawData.forEach((row, rowIndex) => {
                    // Add to output sheet
                    const addedRow = outWs.addRow(row);
                    
                    if(rowIndex === 0) return; // Skip Header

                    row.forEach((cellVal, colIndex) => {
                        // Check if it's a string and has reasonable length
                        if (typeof cellVal === 'string' && cellVal.length > 3 && !cellVal.includes("http")) {
                            cellsToFix.push({ 
                                r: rowIndex + 1, // ExcelJS is 1-based
                                c: colIndex + 1, 
                                original: cellVal 
                            });
                        }
                    });
                });

                log(`Found ${cellsToFix.length} potential text items to check.`);
                
                // 5. BATCH PROCESSING
                const BATCH_SIZE = 30; // Safer batch size
                let totalFixed = 0;

                for (let i = 0; i < cellsToFix.length; i += BATCH_SIZE) {
                    const batch = cellsToFix.slice(i, i + BATCH_SIZE);
                    
                    // Update Progress
                    const pct = Math.round((i / cellsToFix.length) * 100);
                    document.getElementById('progress-bar').style.width = `${pct}%`;
                    document.getElementById('status-title').innerText = `Fixing Batch ${Math.ceil(i/BATCH_SIZE) + 1}...`;

                    // Create Prompt
                    // We map batch to format: "ID: Text"
                    const listText = batch.map((item, idx) => `${idx} || ${item.original}`).join("\n");

                    const prompt = `
                        You are a strict Restaurant Menu Editor.
                        Task: Fix spelling, capitalization, and formatting errors in these food items.
                        
                        CRITICAL RULES:
                        1. Context is Indian/Chinese/Continental food.
                        2. Fix "Buter"->"Butter", "Noon"->"Naan", "Fires"->"Fries", "Rcie"->"Rice", "Chiken"->"Chicken".
                        3. Fix "Masla"->"Masala", "Noodels"->"Noodles".
                        4. Output MUST be a valid JSON Array of objects: [{"id": 0, "fixed": "Corrected Text"}].
                        5. Do NOT change the ID. Return ALL items even if unchanged.
                        
                        INPUT LIST:
                        ${listText}
                    `;

                    try {
                        const result = await model.generateContent(prompt);
                        let responseText = result.response.text();
                        
                        // SANITIZE JSON (Remove markdown code blocks if AI adds them)
                        responseText = responseText.replace(/```json/g, "").replace(/```/g, "").trim();
                        
                        const jsonResponse = JSON.parse(responseText);

                        // Apply Changes
                        jsonResponse.forEach(fixedItem => {
                            const idx = parseInt(fixedItem.id);
                            if (!isNaN(idx) && idx < batch.length) {
                                const originalData = batch[idx];
                                const fixedText = fixedItem.fixed.trim();

                                // Compare strict equality
                                if (fixedText !== originalData.original.trim()) {
                                    const cell = outWs.getCell(originalData.r, originalData.c);
                                    cell.value = fixedText;
                                    
                                    // Highlight RED for visibility
                                    cell.font = { color: { argb: 'FFFF0000' }, bold: true };
                                    
                                    log(`Fixed: ${originalData.original} -> ${fixedText}`);
                                    totalFixed++;
                                }
                            }
                        });

                    } catch (err) {
                        console.error("Batch Error:", err);
                        log(`Error in batch (skipping)... ${err.message}`);
                        // Don't stop, continue to next batch
                    }

                    // Small delay to prevent API limits
                    await new Promise(r => setTimeout(r, 800));
                }

                // 6. Finish
                processedWorkbook = outWb;
                document.getElementById('processing-view').classList.add('hidden');
                document.getElementById('success-view').classList.remove('hidden');
                document.getElementById('result-stats').innerText = `Successfully fixed ${totalFixed} spelling errors!`;

            } catch (error) {
                console.error(error);
                alert("Critical Error: " + error.message);
                location.reload();
            }
        }

        // Global Download Function
        window.downloadResult = async function() {
            if (!processedWorkbook) return;
            const buffer = await processedWorkbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            saveAs(blob, "AI_Fixed_Menu_Final.xlsx");
        }
    </script>
</body>
</html>
