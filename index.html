<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Achievers | Pdf Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f3f4f6; overflow: hidden; height: 100vh; display: flex; flex-direction: column; font-family: 'Inter', sans-serif; }
        #main-content { flex: 1; display: flex; overflow: hidden; }
        #thumbnail-sidebar { width: 140px; background: #ffffff; border-right: 1px solid #e5e7eb; overflow-y: auto; padding: 15px; }
        .thumb-page { border: 2px solid #e5e7eb; margin-bottom: 15px; cursor: pointer; border-radius: 6px; background: #f9fafb; position: relative; }
        .thumb-page.active { border-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.2); }
        .thumb-label { font-size: 11px; text-align: center; color: #64748b; padding: 4px; font-weight: 600; }
        #editor-viewport { flex: 1; overflow: auto; display: flex; flex-direction: column; align-items: center; background: #e2e8f0; padding: 40px; }
        #pages-container { transform-origin: top center; transition: transform 0.2s ease; }
        .page-wrapper { position: relative; margin-bottom: 40px; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .canvas-container { position: absolute !important; top: 0; left: 0; }
        .toolbar-icon-btn { flex-direction: column; display: flex; align-items: center; padding: 8px; border-radius: 6px; transition: all 0.2s; color: #4b5563; }
        .toolbar-icon-btn:hover { background: #f3f4f6; color: #ef4444; }
        #format-bar { background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; padding: 8px 24px; gap: 16px; height: 50px; }
        #bottom-nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 24px; border-radius: 99px; display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 100; }
        .loader-spin { border: 2px solid #f3f3f3; border-top: 2px solid #ef4444; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav class="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-6 z-50">
        <div class="flex items-center gap-2">
            <button onclick="document.getElementById('upload-pdf').click()" class="toolbar-icon-btn">
                <i class="fas fa-folder-open"></i><span class="text-[9px] mt-1 uppercase font-bold">Open PDF</span>
            </button>
            <div class="w-px h-6 bg-gray-200 mx-2"></div>
            <button onclick="addText()" class="toolbar-icon-btn">
                <i class="fas fa-font"></i><span class="text-[9px] mt-1 uppercase font-bold">Add Text</span>
            </button>
            <button onclick="document.getElementById('img-upload').click()" class="toolbar-icon-btn">
                <i class="fas fa-image"></i><span class="text-[9px] mt-1 uppercase font-bold">Add Image</span>
            </button>
            <div class="w-px h-6 bg-gray-200 mx-2"></div>
            <button onclick="deleteSelected()" class="toolbar-icon-btn hover:text-red-600">
                <i class="fas fa-trash"></i><span class="text-[9px] mt-1 text-red-500 uppercase font-bold">Delete</span>
            </button>
        </div>

        <div class="flex items-center gap-4">
            <span class="text-sm font-bold text-gray-800">The <span class="text-red-500">Achievers</span> Editor</span>
            <button onclick="exportFinalPDF()" id="export-btn" class="bg-red-500 hover:bg-red-600 text-white px-8 py-2.5 rounded-full text-[10px] font-black shadow-lg transition tracking-widest">
                EXPORT PDF <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </nav>

    <div id="format-bar">
        <select id="font-family" class="border rounded px-2 py-1 text-xs outline-none bg-gray-50 font-medium">
            <option value="Arial">Arial</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Courier">Courier</option>
        </select>
        <select id="font-size" class="border rounded px-2 py-1 text-xs outline-none bg-gray-50 font-medium">
            <option value="12">12 px</option>
            <option value="18">18 px</option>
            <option value="24" selected>24 px</option>
            <option value="36">36 px</option>
            <option value="48">48 px</option>
        </select>
        <div class="flex border rounded overflow-hidden">
            <button onclick="toggleStyle('bold')" class="px-3 py-1 text-xs bg-white hover:bg-gray-100 border-r transition"><b>B</b></button>
            <button onclick="toggleStyle('italic')" class="px-3 py-1 text-xs bg-white hover:bg-gray-100 transition"><i>I</i></button>
        </div>
    </div>

    <div id="main-content">
        <aside id="thumbnail-sidebar">
            <div id="thumbs-list"></div>
        </aside>

        <main id="editor-viewport">
            <div id="pages-container">
                <div id="welcome-screen" class="mt-40 text-center text-gray-400">
                    <i class="fas fa-file-pdf text-6xl mb-4 opacity-10"></i>
                    <p class="text-sm">Click <b>Open PDF</b> to load your document</p>
                </div>
            </div>
        </main>
    </div>

    <div id="bottom-nav">
        <button onclick="changePage(-1)" class="hover:text-red-400 transition"><i class="fas fa-chevron-left"></i></button>
        <span id="page-info" class="text-[11px] font-black min-w-[80px] text-center uppercase tracking-tighter">Page 0 / 0</span>
        <button onclick="changePage(1)" class="hover:text-red-400 transition"><i class="fas fa-chevron-right"></i></button>
        
        <div class="w-px h-4 bg-gray-700"></div>
        
        <button onclick="adjustZoom(-0.1)" class="hover:text-red-400 transition"><i class="fas fa-search-minus"></i></button>
        <button onclick="adjustZoom(0.1)" class="hover:text-red-400 transition"><i class="fas fa-search-plus"></i></button>
    </div>

    <input type="file" id="upload-pdf" accept="application/pdf" class="hidden">
    <input type="file" id="img-upload" accept="image/*" class="hidden" onchange="processImage(this)">

    <script>
        const { PDFDocument } = PDFLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let originalPdfBytes;
        let fabricCanvases = []; 
        let activePage = 0;
        let scaleZoom = 1.0;

        document.getElementById('upload-pdf').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            originalPdfBytes = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(originalPdfBytes.slice(0)) }).promise;
            const container = document.getElementById('pages-container');
            const thumbList = document.getElementById('thumbs-list');
            container.innerHTML = ''; thumbList.innerHTML = ''; fabricCanvases = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                const wrapper = document.createElement('div');
                wrapper.className = 'page-wrapper';
                wrapper.id = `page-wrap-${i-1}`;
                wrapper.style.width = `${viewport.width}px`;
                wrapper.style.height = `${viewport.height}px`;
                const bg = document.createElement('canvas');
                bg.width = viewport.width; bg.height = viewport.height;
                const fg = document.createElement('canvas');
                fg.id = `fg-${i}`;
                wrapper.appendChild(bg); wrapper.appendChild(fg); container.appendChild(wrapper);
                await page.render({ canvasContext: bg.getContext('2d'), viewport }).promise;
                const fCanvas = new fabric.Canvas(`fg-${i}`, { width: viewport.width, height: viewport.height });
                fabricCanvases.push(fCanvas);
                const thumbItem = document.createElement('div');
                thumbItem.className = `thumb-page ${i===1?'active':''}`;
                thumbItem.onclick = () => jumpToPage(i-1);
                const tCanvas = document.createElement('canvas');
                const tCtx = tCanvas.getContext('2d');
                const tView = page.getViewport({ scale: 0.15 });
                tCanvas.width = tView.width; tCanvas.height = tView.height;
                await page.render({ canvasContext: tCtx, viewport: tView }).promise;
                thumbItem.appendChild(tCanvas);
                const lbl = document.createElement('div');
                lbl.className = 'thumb-label'; lbl.innerText = i;
                thumbItem.appendChild(lbl); thumbList.appendChild(thumbItem);
            }
            refreshStatus();
        });

        function adjustZoom(val) {
            scaleZoom = Math.min(Math.max(0.4, scaleZoom + val), 2.0);
            document.getElementById('pages-container').style.transform = `scale(${scaleZoom})`;
        }
        function jumpToPage(idx) {
            document.getElementById(`page-wrap-${idx}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
            activePage = idx; refreshStatus();
        }
        function changePage(dir) {
            const n = activePage + dir;
            if (n >= 0 && n < fabricCanvases.length) jumpToPage(n);
        }
        document.getElementById('editor-viewport').addEventListener('scroll', () => {
            const wraps = document.querySelectorAll('.page-wrapper');
            wraps.forEach((w, idx) => {
                const r = w.getBoundingClientRect();
                if (r.top < window.innerHeight / 2 && r.bottom > window.innerHeight / 2) {
                    activePage = idx;
                    document.querySelectorAll('.thumb-page').forEach((t, i) => {
                        i === idx ? t.classList.add('active') : t.classList.remove('active');
                    });
                }
            });
            refreshStatus();
        });
        function refreshStatus() {
            document.getElementById('page-info').innerText = `PAGE ${activePage + 1} / ${fabricCanvases.length || 0}`;
        }
        function addText() {
            const canvas = fabricCanvases[activePage];
            if(!canvas) return;
            const text = new fabric.IText("Double click to edit", {
                left: 150, top: 150,
                fontFamily: document.getElementById('font-family').value,
                fontSize: parseInt(document.getElementById('font-size').value),
                fill: '#ef4444', fontWeight: 'bold'
            });
            canvas.add(text).setActiveObject(text);
        }
        function processImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => fabric.Image.fromURL(e.target.result, (img) => {
                    img.scaleToWidth(250); fabricCanvases[activePage].add(img).setActiveObject(img);
                });
                reader.readAsDataURL(input.files[0]);
            }
        }
        function deleteSelected() {
            const c = fabricCanvases[activePage];
            if(c && c.getActiveObject()) c.remove(c.getActiveObject());
        }
        function toggleStyle(style) {
            const activeObject = fabricCanvases[activePage].getActiveObject();
            if (!activeObject || activeObject.type !== 'i-text') return;
            if (style === 'bold') activeObject.set('fontWeight', activeObject.fontWeight === 'bold' ? 'normal' : 'bold');
            else if (style === 'italic') activeObject.set('fontStyle', activeObject.fontStyle === 'italic' ? 'normal' : 'italic');
            fabricCanvases[activePage].renderAll();
        }

        async function exportFinalPDF() {
            if (!originalPdfBytes) return;
            const btn = document.getElementById('export-btn');
            btn.innerHTML = `<span class="loader-spin mr-2"></span> EXPORTING...`; 
            btn.disabled = true;
            
            try {
                // Ensure we use a fresh copy of the bytes to prevent memory reference issues
                const pdfDoc = await PDFDocument.load(originalPdfBytes.slice(0));
                const pages = pdfDoc.getPages();
                
                for (let i = 0; i < fabricCanvases.length; i++) {
                    const canvas = fabricCanvases[i];
                    // Skip if no edits on this page
                    if (canvas.getObjects().length === 0) continue;

                    const pdfPage = pages[i];
                    const { width, height } = pdfPage.getSize();

                    // multipliers increase quality but also memory usage. 2 is a good balance.
                    const dataURL = canvas.toDataURL({ format: 'png', multiplier: 2 });
                    const imageBytes = await fetch(dataURL).then(res => res.arrayBuffer());
                    const pngImage = await pdfDoc.embedPng(imageBytes);

                    pdfPage.drawImage(pngImage, { 
                        x: 0, 
                        y: 0, 
                        width: width, 
                        height: height 
                    });
                }

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "Edited_Document.pdf"; 
                link.click();
                
            } catch (err) { 
                console.error("Export Error:", err);
                alert("An error occurred during export. If the file is very large, try reducing the number of images added."); 
            } finally { 
                btn.innerHTML = `EXPORT PDF <i class="fas fa-arrow-right ml-2"></i>`; 
                btn.disabled = false; 
            }
        }
    </script>
</body>
</html>
